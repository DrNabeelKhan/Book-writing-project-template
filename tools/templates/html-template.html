<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>$title$</title>
    <meta name="author" content="$author$" />
    <meta name="description" content="$subtitle$" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;700&family=Google+Sans:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Prism.js Syntax Highlighting -->
    <link
      href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>

    <!-- Lunr.js Full-Text Search -->
    <script src="https://cdn.jsdelivr.net/npm/lunr/lunr.min.js"></script>

    <style>
      /* ------------------------------
       Base Typography
    ------------------------------ */
      body {
        max-width: 900px;
        margin: 2rem auto;
        font-family: "Noto Sans", system-ui, sans-serif;
        line-height: 1.7;
        padding: 0 1rem;
        transition:
          background 0.3s,
          color 0.3s;
      }

      h1,
      h2,
      h3,
      h4 {
        margin-top: 2rem;
        font-family: "Google Sans", "Noto Sans", sans-serif;
        font-weight: 700;
      }

      a {
        color: #0366d6;
      }

      pre {
        padding: 1rem;
        border-radius: 6px;
        overflow-x: auto;
      }

      /* ------------------------------
       Responsive Sidebar TOC
    ------------------------------ */
      .toc-container {
        display: flex;
        gap: 2rem;
      }

      nav.toc {
        flex: 0 0 250px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 1rem;
        background: #f9f9f9;
        border-radius: 8px;
        position: sticky;
        top: 1rem;
      }

      main {
        flex: 1;
        min-width: 0;
      }

      @media (max-width: 900px) {
        .toc-container {
          flex-direction: column;
        }
        nav.toc {
          position: relative;
          max-height: none;
        }
      }

      /* ------------------------------
       Dark Mode
    ------------------------------ */
      @media (prefers-color-scheme: dark) {
        body {
          background: #121212;
          color: #e0e0e0;
        }
        nav.toc {
          background: #1e1e1e;
        }
        a {
          color: #80b3ff;
        }
      }

      body.dark {
        background: #121212;
        color: #e0e0e0;
      }
      body.dark nav.toc {
        background: #1e1e1e;
      }
      body.dark a {
        color: #80b3ff;
      }

      /* ------------------------------
       Print-Optimized CSS
    ------------------------------ */
      @media print {
        nav.toc {
          display: none;
        }
        body {
          max-width: 100%;
          margin: 0;
          padding: 0;
          font-size: 12pt;
        }
        h1,
        h2,
        h3,
        h4 {
          page-break-after: avoid;
        }
        pre {
          background: #f0f0f0 !important;
          border: 1px solid #ccc;
        }
      }

      /* ------------------------------
       Dark Mode Toggle Button
    ------------------------------ */
      #darkToggle {
        position: fixed;
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
        background: #eee;
        border-radius: 6px;
        cursor: pointer;
        font-family: "Noto Sans";
        z-index: 999;
      }
      body.dark #darkToggle {
        background: #333;
        color: #fff;
      }

      /* ------------------------------
       Search Bar
    ------------------------------ */
      #searchBox {
        width: 100%;
        padding: 0.7rem;
        margin-bottom: 1rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 1rem;
      }

      #searchResults p {
        background: #f0f0f0;
        padding: 0.5rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
      }

      /* ------------------------------
       Floating Progress Bar
    ------------------------------ */
      #progressBar {
        position: fixed;
        top: 0;
        left: 0;
        height: 4px;
        background: #0366d6;
        width: 0%;
        z-index: 1000;
        transition: width 0.1s;
      }

      /* ------------------------------
       Chapter Navigation Arrows
    ------------------------------ */
      .nav-arrows {
        display: flex;
        justify-content: space-between;
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid #ddd;
      }

      .nav-arrows a {
        font-size: 1.1rem;
        font-weight: 600;
        text-decoration: none;
      }
    </style>
  </head>

  <body>
    <div id="progressBar"></div>
    <button id="darkToggle">Toggle Dark Mode</button>

    <header>
      <h1>$title$</h1>
      <h2>$subtitle$</h2>
      <p><em>$author$ — $date$</em></p>
    </header>

    <input id="searchBox" type="text" placeholder="Search this book..." />
    <div id="searchResults"></div>

    <div class="toc-container">
      $if(toc)$
      <nav class="toc">
        <h2>Contents</h2>
        $toc$
      </nav>
      $endif$

      <main id="content">
        $body$

        <div class="nav-arrows">
          <a href="#" id="prevChapter">⬅ Previous</a>
          <a href="#" id="nextChapter">Next ➡</a>
        </div>
      </main>
    </div>

    <script>
      /* ------------------------------
       Dark Mode Toggle
    ------------------------------ */
      const btn = document.getElementById("darkToggle");
      btn.onclick = () => {
        document.body.classList.toggle("dark");
        localStorage.setItem(
          "darkMode",
          document.body.classList.contains("dark"),
        );
      };
      if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark");
      }

      /* ------------------------------
       Floating Progress Bar
    ------------------------------ */
      const progressBar = document.getElementById("progressBar");

      window.addEventListener("scroll", () => {
        const scrollTop = window.scrollY;
        const docHeight = document.body.scrollHeight - window.innerHeight;
        const progress = (scrollTop / docHeight) * 100;
        progressBar.style.width = progress + "%";
      });

      /* ------------------------------
       Lunr.js Full-Text Search
    ------------------------------ */
      let lunrIndex;
      let documents = {};

      async function loadSearch() {
        const response = await fetch("search-index.json");
        const data = await response.json();

        documents = {};
        data.forEach((doc) => (documents[doc.id] = doc));

        lunrIndex = lunr(function () {
          this.ref("id");
          this.field("title");
          this.field("body");

          data.forEach((doc) => this.add(doc));
        });
      }

      loadSearch();

      document.getElementById("searchBox").addEventListener("input", () => {
        const query = searchBox.value.trim();
        const resultsDiv = document.getElementById("searchResults");

        if (!query) {
          resultsDiv.innerHTML = "";
          return;
        }

        const results = lunrIndex.search(query);
        let html = "";

        results.forEach((r) => {
          const doc = documents[r.ref];
          html += `<p><strong>${doc.title}</strong><br>${doc.body.substring(0, 200)}...</p>`;
        });

        resultsDiv.innerHTML = html;
      });

      /* ------------------------------
       Chapter Navigation
    ------------------------------ */
      let chapterList = [];
      let currentChapter = "$current_chapter$";

      async function loadChapters() {
        const response = await fetch("chapter-index.json");
        chapterList = await response.json();

        const idx = chapterList.indexOf(currentChapter);

        const prev = document.getElementById("prevChapter");
        const next = document.getElementById("nextChapter");

        if (idx > 0) {
          prev.href = chapterList[idx - 1].replace(".md", ".html");
          prev.style.visibility = "visible";
        } else {
          prev.style.visibility = "hidden";
        }

        if (idx < chapterList.length - 1) {
          next.href = chapterList[idx + 1].replace(".md", ".html");
          next.style.visibility = "visible";
        } else {
          next.style.visibility = "hidden";
        }
      }

      loadChapters();
    </script>
  </body>
</html>
